<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Comiss√µes - Firebase</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC0I8tWPVrHLxzhxja7gKgK9jKu9nRVZR8",
            authDomain: "app-comissoes.firebaseapp.com",
            projectId: "app-comissoes",
            storageBucket: "app-comissoes.firebasestorage.app",
            messagingSenderId: "223601290975",
            appId: "1:223601290975:web:0e2197a34999d28f58036a"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Disponibilizar globalmente
        window.firebase = { db, auth, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, signInWithEmailAndPassword, signOut, onAuthStateChanged };
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 95%;
            max-width: 1400px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .login-container {
            padding: 40px;
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .login-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary { background: #6c757d; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        .btn-info { background: #17a2b8; }
        .btn-warning { background: #ffc107; color: #212529; }

        .dashboard {
            display: none;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .card .subtitle {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 8px;
        }

        .card.success .value { color: #28a745; }
        .card.warning .value { color: #ffc107; }
        .card.danger .value { color: #dc3545; }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .sales-table th,
        .sales-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .sales-table th {
            background-color: #e9ecef;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .ranking-container {
            display: grid;
            gap: 15px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 10px;
            background: white;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .ranking-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .ranking-item.current-user {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .ranking-item.gold {
            border-left-color: #ffd700;
            background: linear-gradient(135deg, #fff8dc 0%, #f0e68c 100%);
        }

        .ranking-item.silver {
            border-left-color: #c0c0c0;
            background: linear-gradient(135deg, #f8f8ff 0%, #e6e6fa 100%);
        }

        .ranking-item.bronze {
            border-left-color: #cd7f32;
            background: linear-gradient(135deg, #fdf5e6 0%, #f5deb3 100%);
        }

        .position {
            font-weight: bold;
            font-size: 1.5rem;
            color: #667eea;
            margin-right: 15px;
            min-width: 40px;
        }

        .medal {
            font-size: 1.8rem;
            margin-right: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            height: 400px;
            position: relative;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pago {
            background: #d4edda;
            color: #155724;
        }

        .status-pendente {
            background: #fff3cd;
            color: #856404;
        }

        .status-parcial {
            background: #cce5ff;
            color: #004085;
        }

        .installment-info {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 4px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            margin-left: 10px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .user-management {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .container {
                width: 95%;
                margin: 10px;
            }
            
            .dashboard {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .cards-container {
                grid-template-columns: 1fr;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tela de Login -->
        <div id="login-screen" class="login-container">
            <h1>üî• Sistema de Comiss√µes</h1>
            <div class="login-form">
                <div class="form-group">
                    <label for="userType">Tipo de Usu√°rio:</label>
                    <select id="userType">
                        <option value="vendedor">Vendedor</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="username">Usu√°rio:</label>
                    <input type="text" id="username" placeholder="Digite seu usu√°rio">
                </div>
                
                <div class="form-group">
                    <label for="password">Senha:</label>
                    <input type="password" id="password" placeholder="Digite sua senha">
                </div>
                
                <button class="btn" onclick="login()">Entrar</button>
                <div id="login-error" class="error" style="display: none;"></div>
                <div id="loading" class="loading" style="display: none;">üîÑ Carregando...</div>
            </div>
        </div>

        <!-- Dashboard do Vendedor -->
        <div id="vendedor-dashboard" class="dashboard">
            <div class="header">
                <div>
                    <h1>üíº Dashboard - <span id="vendedor-name"></span></h1>
                </div>
                <div class="user-info">
                    <span style="color: #28a745;">üü¢ Online</span>
                    <button class="btn btn-danger" onclick="logout()">Sair</button>
                </div>
            </div>

            <div class="cards-container">
                <div class="card">
                    <h3>üí∞ Total de Comiss√µes</h3>
                    <div class="value" id="total-comissoes-vendedor">R$ 0,00</div>
                    <div class="subtitle">Valor total gerado</div>
                </div>
                <div class="card success">
                    <h3>‚úÖ Comiss√µes Recebidas</h3>
                    <div class="value" id="comissoes-pagas-vendedor">R$ 0,00</div>
                    <div class="subtitle">J√° recebido</div>
                </div>
                <div class="card warning">
                    <h3>‚è≥ Pendentes</h3>
                    <div class="value" id="comissoes-pendentes-vendedor">R$ 0,00</div>
                    <div class="subtitle">A receber</div>
                </div>
                <div class="card">
                    <h3>üèÜ Posi√ß√£o no Ranking</h3>
                    <div class="value" id="posicao-ranking">-</div>
                    <div class="subtitle">Na equipe</div>
                </div>
                <div class="card">
                    <h3>üìà Total de Vendas</h3>
                    <div class="value" id="total-vendas-vendedor">0</div>
                    <div class="subtitle">Vendas realizadas</div>
                </div>
                <div class="card">
                    <h3>üíé Ticket M√©dio</h3>
                    <div class="value" id="ticket-medio-vendedor">R$ 0,00</div>
                    <div class="subtitle">Valor m√©dio por venda</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="section">
                    <h2>üìä Evolu√ß√£o Mensal</h2>
                    <div class="chart-container">
                        <canvas id="vendedor-chart"></canvas>
                    </div>
                </div>

                <div class="section">
                    <h2>üèÜ Ranking da Equipe</h2>
                    <div id="ranking-list" class="ranking-container"></div>
                </div>
            </div>

            <div class="section">
                <h2>üìã Minhas Vendas</h2>
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Valor</th>
                            <th>Comiss√£o</th>
                            <th>Status</th>
                            <th>Parcelas</th>
                        </tr>
                    </thead>
                    <tbody id="vendas-vendedor">
                        <tr><td colspan="6" class="loading">üîÑ Carregando vendas...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dashboard do Admin -->
        <div id="admin-dashboard" class="dashboard">
            <div class="header">
                <div>
                    <h1>‚öôÔ∏è Painel Administrativo</h1>
                </div>
                <div class="user-info">
                    <button class="btn btn-success" onclick="openNewSaleModal()">+ Nova Venda</button>
                    <button class="btn btn-info" onclick="openUserManagementModal()">üë• Vendedores</button>
                    <button class="btn btn-secondary" onclick="openCommissionRulesModal()">üìã Regras</button>
                    <span style="color: #28a745;">üü¢ Online</span>
                    <button class="btn btn-danger" onclick="logout()">Sair</button>
                </div>
            </div>

            <div class="cards-container">
                <div class="card">
                    <h3>üìä Total Geral de Vendas</h3>
                    <div class="value" id="admin-total-vendas">0</div>
                    <div class="subtitle">Vendas realizadas</div>
                </div>
                <div class="card success">
                    <h3>üí∞ Faturamento Total</h3>
                    <div class="value" id="admin-faturamento-total">R$ 0,00</div>
                    <div class="subtitle">Valor total vendido</div>
                </div>
                <div class="card">
                    <h3>üíé Comiss√µes Pagas</h3>
                    <div class="value" id="admin-total-comissoes">R$ 0,00</div>
                    <div class="subtitle">J√° pagas</div>
                </div>
                <div class="card warning">
                    <h3>‚è≥ Comiss√µes Pendentes</h3>
                    <div class="value" id="admin-comissoes-pendentes">R$ 0,00</div>
                    <div class="subtitle">A pagar</div>
                </div>
                <div class="card">
                    <h3>üë• Vendedores Ativos</h3>
                    <div class="value" id="admin-vendedores-ativos">0</div>
                    <div class="subtitle">Com vendas no m√™s</div>
                </div>
                <div class="card">
                    <h3>üí∞ Ticket M√©dio</h3>
                    <div class="value" id="admin-ticket-medio">R$ 0,00</div>
                    <div class="subtitle">Valor m√©dio por venda</div>
                </div>
            </div>

            <div class="section">
                <h2>üìà Panorama de Vendas</h2>
                <div class="chart-container">
                    <canvas id="admin-chart"></canvas>
                </div>
            </div>

            <div class="section">
                <h2>üìã Todas as Vendas</h2>
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Vendedor</th>
                            <th>Cliente</th>
                            <th>Valor</th>
                            <th>Comiss√£o</th>
                            <th>Status</th>
                            <th>Parcelas</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="todas-vendas">
                        <tr><td colspan="8" class="loading">üîÑ Carregando vendas...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>üèÜ Ranking Completo</h2>
                <div id="admin-ranking-list" class="ranking-container"></div>
            </div>
        </div>
    </div>

    <!-- Modal Nova Venda -->
    <div id="newSaleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNewSaleModal()">&times;</span>
            <h2>üí∞ Nova Venda</h2>
            <div class="form-group">
                <label for="vendedor-select">Vendedor:</label>
                <select id="vendedor-select"></select>
            </div>
            <div class="form-group">
                <label for="cliente-input">Cliente:</label>
                <input type="text" id="cliente-input" placeholder="Nome do cliente">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="valor-input">Valor da Venda:</label>
                    <input type="number" id="valor-input" placeholder="0,00" step="0.01">
                </div>
                <div class="form-group">
                    <label for="comissao-input">% Comiss√£o:</label>
                    <input type="number" id="comissao-input" placeholder="5" step="0.1" min="0" max="100">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="parcelas-input">N√∫mero de Parcelas:</label>
                    <select id="parcelas-input">
                        <option value="1">√Ä vista (1x)</option>
                        <option value="2">2 parcelas</option>
                        <option value="3">3 parcelas</option>
                        <option value="4">4 parcelas</option>
                        <option value="5">5 parcelas</option>
                        <option value="6">6 parcelas</option>
                        <option value="7">7 parcelas</option>
                        <option value="8">8 parcelas</option>
                        <option value="9">9 parcelas</option>
                        <option value="10">10 parcelas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="status-input">Status:</label>
                    <select id="status-input">
                        <option value="pendente">Pendente</option>
                        <option value="pago">Pago</option>
                    </select>
                </div>
            </div>
            <button class="btn" onclick="addSale()">Adicionar Venda</button>
        </div>
    </div>

    <!-- Modal Gerenciar Vendedores -->
    <div id="userManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUserManagementModal()">&times;</span>
            <h2>üë• Gerenciar Vendedores</h2>
            <div class="user-management">
                <div id="users-list"></div>
                <h3>Novo Vendedor</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new-user-name">Nome Completo:</label>
                        <input type="text" id="new-user-name" placeholder="Ex: Jo√£o Silva">
                    </div>
                    <div class="form-group">
                        <label for="new-username">Nome de Usu√°rio:</label>
                        <input type="text" id="new-username" placeholder="Ex: joao">
                    </div>
                </div>
                <div class="form-group">
                    <label for="new-password">Senha:</label>
                    <input type="password" id="new-password" placeholder="Senha padr√£o">
                </div>
                <button class="btn btn-success" onclick="addUser()">Adicionar Vendedor</button>
            </div>
        </div>
    </div>

    <!-- Modal Regras de Comiss√£o -->
    <div id="commissionRulesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCommissionRulesModal()">&times;</span>
            <h2>üìã Regras de Comiss√£o</h2>
            <div class="commission-rules">
                <div id="rules-list"></div>
                <h3>Nova Regra</h3>
                <div class="form-group">
                    <label for="rule-name">Nome da Regra:</label>
                    <input type="text" id="rule-name" placeholder="Ex: Vendas at√© R$ 1000">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="rule-percentage">Percentual (%):</label>
                        <input type="number" id="rule-percentage" placeholder="5" step="0.1" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="rule-installments">Parcelas de Comiss√£o:</label>
                        <select id="rule-installments">
                            <option value="1">√Ä vista (1x)</option>
                            <option value="2">2 parcelas</option>
                            <option value="3">3 parcelas</option>
                            <option value="4">4 parcelas</option>
                            <option value="5">5 parcelas</option>
                            <option value="6">6 parcelas</option>
                            <option value="7">7 parcelas</option>
                            <option value="8">8 parcelas</option>
                            <option value="9">9 parcelas</option>
                            <option value="10">10 parcelas</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success" onclick="addCommissionRule()">Adicionar Regra</button>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let currentUser = null;
        let salesData = [];
        let users = [];
        let commissionRules = [];
        let vendedorChart = null;
        let adminChart = null;
        let salesListener = null;
        let usersListener = null;
        let rulesListener = null;

        // Sistema de inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading();
            await initializeFirebaseData();
            hideLoading();
        });

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Inicializar dados do Firebase
        async function initializeFirebaseData() {
            try {
                // Carregar usu√°rios
                await loadUsers();
                
                // Carregar regras de comiss√£o
                await loadCommissionRules();
                
                // Se n√£o houver dados, criar dados iniciais
                if (users.length === 0) {
                    await createInitialData();
                }
                
                console.log('‚úÖ Firebase inicializado com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Firebase:', error);
                showError('Erro ao conectar com o servidor. Verifique sua conex√£o.');
            }
        }

        // Criar dados iniciais no Firebase
        async function createInitialData() {
            const { db, collection, addDoc } = window.firebase;
            
            // Usu√°rios iniciais
            const initialUsers = [
                { username: 'joao', password: '123', type: 'vendedor', name: 'Jo√£o Silva' },
                { username: 'maria', password: '123', type: 'vendedor', name: 'Maria Santos' },
                { username: 'pedro', password: '123', type: 'vendedor', name: 'Pedro Costa' },
                { username: 'admin', password: 'admin123', type: 'admin', name: 'Administrador' }
            ];

            // Regras iniciais
            const initialRules = [
                { name: 'Padr√£o', percentage: 5, installments: 1 },
                { name: 'Vendas acima de R$ 5000', percentage: 7, installments: 2 },
                { name: 'Vendas acima de R$ 10000', percentage: 10, installments: 3 }
            ];

            try {
                // Adicionar usu√°rios
                for (const user of initialUsers) {
                    await addDoc(collection(db, 'users'), user);
                }

                // Adicionar regras
                for (const rule of initialRules) {
                    await addDoc(collection(db, 'commissionRules'), rule);
                }

                // Gerar algumas vendas de exemplo
                await generateSampleSales();
                
                console.log('‚úÖ Dados iniciais criados!');
            } catch (error) {
                console.error('‚ùå Erro ao criar dados iniciais:', error);
            }
        }

        // Gerar vendas de exemplo
        async function generateSampleSales() {
            const { db, collection, addDoc } = window.firebase;
            const months = ['2024-01-15', '2024-02-20', '2024-03-10', '2024-04-05', '2024-05-12'];
            const vendedores = ['joao', 'maria', 'pedro'];
            const clientes = ['Empresa ABC', 'Empresa XYZ', 'Empresa DEF', 'Empresa GHI', 'Empresa JKL'];
            
            for (const month of months) {
                for (const vendedor of vendedores) {
                    const numVendas = Math.floor(Math.random() * 3) + 1;
                    for (let i = 0; i < numVendas; i++) {
                        const valor = Math.floor(Math.random() * 15000) + 1000;
                        const comissaoPerc = valor > 10000 ? 10 : valor > 5000 ? 7 : 5;
                        const installments = Math.floor(Math.random() * 10) + 1;
                        const paidInstallments = Math.floor(Math.random() * (installments + 1));
                        
                        const saleData = {
                            data: new Date(month),
                            vendedor: vendedor,
                            cliente: clientes[Math.floor(Math.random() * clientes.length)],
                            valor: valor,
                            comissaoPerc: comissaoPerc,
                            comissaoValor: (valor * comissaoPerc) / 100,
                            installments: installments,
                            paidInstallments: paidInstallments,
                            createdAt: new Date()
                        };
                        
                        await addDoc(collection(db, 'sales'), saleData);
                    }
                }
            }
        }

        // Carregar usu√°rios do Firebase
        async function loadUsers() {
            const { db, collection, getDocs, onSnapshot } = window.firebase;
            
            // Listener em tempo real
            if (usersListener) usersListener();
            usersListener = onSnapshot(collection(db, 'users'), (snapshot) => {
                users = [];
                snapshot.forEach((doc) => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                if (currentUser && currentUser.type === 'admin') {
                    populateVendedorSelect();
                    loadUsersList();
                }
            });
        }

        // Carregar vendas do Firebase
        async function loadSales() {
            const { db, collection, onSnapshot, query, orderBy } = window.firebase;
            
            // Listener em tempo real para vendas
            if (salesListener) salesListener();
            salesListener = onSnapshot(query(collection(db, 'sales'), orderBy('data', 'desc')), (snapshot) => {
                salesData = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    salesData.push({ 
                        id: doc.id, 
                        ...data,
                        data: data.data.toDate() // Converter Timestamp para Date
                    });
                });
                
                // Atualizar interface baseado no tipo de usu√°rio
                if (currentUser) {
                    if (currentUser.type === 'vendedor') {
                        updateVendedorStats();
                        loadVendedorSales();
                        loadRanking();
                        createVendedorChart();
                    } else if (currentUser.type === 'admin') {
                        updateAdminStats();
                        loadAllSales();
                        loadAdminRanking();
                        createAdminChart();
                    }
                }
            });
        }

        // Carregar regras de comiss√£o do Firebase
        async function loadCommissionRules() {
            const { db, collection, onSnapshot } = window.firebase;
            
            if (rulesListener) rulesListener();
            rulesListener = onSnapshot(collection(db, 'commissionRules'), (snapshot) => {
                commissionRules = [];
                snapshot.forEach((doc) => {
                    commissionRules.push({ id: doc.id, ...doc.data() });
                });
                
                if (currentUser && currentUser.type === 'admin') {
                    loadCommissionRulesList();
                }
            });
        }

        // Fun√ß√£o de login
        async function login() {
            const userType = document.getElementById('userType').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            showLoading();

            try {
                const user = users.find(u => 
                    u.username === username && 
                    u.password === password && 
                    u.type === userType
                );

                if (user) {
                    currentUser = user;
                    document.getElementById('login-screen').style.display = 'none';
                    
                    // Carregar vendas ap√≥s login
                    await loadSales();
                    
                    if (userType === 'vendedor') {
                        showVendedorDashboard();
                    } else {
                        showAdminDashboard();
                    }
                    
                    errorDiv.style.display = 'none';
                } else {
                    errorDiv.textContent = 'Usu√°rio, senha ou tipo incorretos!';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro no login:', error);
                errorDiv.textContent = 'Erro ao fazer login. Tente novamente.';
                errorDiv.style.display = 'block';
            }

            hideLoading();
        }

        // Fun√ß√£o de logout
        function logout() {
            currentUser = null;
            
            // Parar listeners
            if (salesListener) salesListener();
            if (usersListener) usersListener();
            if (rulesListener) rulesListener();
            
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('vendedor-dashboard').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'none';
            
            // Limpar campos
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Destruir gr√°ficos
            if (vendedorChart) {
                vendedorChart.destroy();
                vendedorChart = null;
            }
            if (adminChart) {
                adminChart.destroy();
                adminChart = null;
            }
        }

        // Mostrar dashboard do vendedor
        function showVendedorDashboard() {
            document.getElementById('vendedor-dashboard').style.display = 'block';
            document.getElementById('vendedor-name').textContent = currentUser.name;
        }

        // Mostrar dashboard do admin
        function showAdminDashboard() {
            document.getElementById('admin-dashboard').style.display = 'block';
            populateVendedorSelect();
        }

        // Atualizar estat√≠sticas do vendedor
        function updateVendedorStats() {
            const vendedorSales = salesData.filter(sale => sale.vendedor === currentUser.username);
            const totalVendas = vendedorSales.length;
            const totalComissoes = vendedorSales.reduce((sum, sale) => sum + sale.comissaoValor, 0);
            const comissoesPagas = vendedorSales.reduce((sum, sale) => 
                sum + (sale.paidInstallments || 0) * (sale.comissaoValor / sale.installments), 0);
            const comissoesPendentes = totalComissoes - comissoesPagas;
            const totalVendido = vendedorSales.reduce((sum, sale) => sum + sale.valor, 0);
            const ticketMedio = totalVendas > 0 ? totalVendido / totalVendas : 0;
            
            document.getElementById('total-comissoes-vendedor').textContent = formatCurrency(totalComissoes);
            document.getElementById('comissoes-pagas-vendedor').textContent = formatCurrency(comissoesPagas);
            document.getElementById('comissoes-pendentes-vendedor').textContent = formatCurrency(comissoesPendentes);
            document.getElementById('total-vendas-vendedor').textContent = totalVendas;
            document.getElementById('ticket-medio-vendedor').textContent = formatCurrency(ticketMedio);
            
            // Calcular posi√ß√£o no ranking
            const ranking = calculateRanking();
            const position = ranking.findIndex(item => item.vendedor === currentUser.username) + 1;
            document.getElementById('posicao-ranking').textContent = position > 0 ? `${position}¬∫` : '-';
        }

        // Carregar vendas do vendedor
        function loadVendedorSales() {
            const tbody = document.getElementById('vendas-vendedor');
            const vendedorSales = salesData.filter(sale => sale.vendedor === currentUser.username);
            
            if (vendedorSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">Nenhuma venda encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = vendedorSales.map(sale => {
                const paidInstallments = sale.paidInstallments || 0;
                const totalInstallments = sale.installments || 1;
                const status = getPaymentStatus(paidInstallments, totalInstallments);
                
                return `
                    <tr>
                        <td>${formatDate(sale.data)}</td>
                        <td>${sale.cliente}</td>
                        <td>${formatCurrency(sale.valor)}</td>
                        <td>${formatCurrency(sale.comissaoValor)} (${sale.comissaoPerc}%)</td>
                        <td><span class="status-badge status-${status.class}">${status.text}</span></td>
                        <td>
                            <div>${paidInstallments}/${totalInstallments}</div>
                            <div class="installment-info">${formatCurrency(sale.comissaoValor / totalInstallments)} por parcela</div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Carregar ranking
        function loadRanking() {
            const ranking = calculateRanking();
            const container = document.getElementById('ranking-list');
            
            container.innerHTML = ranking.map((item, index) => {
                const isCurrentUser = item.vendedor === currentUser.username;
                const displayName = isCurrentUser ? currentUser.name : `Vendedor ${String.fromCharCode(65 + index)}`;
                const medal = getMedal(index);
                const rankClass = getRankClass(index);
                const maxComissao = ranking.length > 0 ? ranking[0].totalComissao : 1;
                const progressPercent = (item.totalComissao / maxComissao) * 100;
                
                return `
                    <div class="ranking-item ${isCurrentUser ? 'current-user' : ''} ${rankClass}">
                        <div style="display: flex; align-items: center;">
                            <span class="medal">${medal}</span>
                            <div>
                                <span class="position">${index + 1}¬∫</span>
                                <strong>${displayName}</strong>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div><strong>${formatCurrency(item.totalComissao)}</strong></div>
                            <div style="font-size: 0.9rem; color: #666;">${item.totalVendas} vendas</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Atualizar estat√≠sticas do admin
        function updateAdminStats() {
            const totalVendas = salesData.length;
            const faturamentoTotal = salesData.reduce((sum, sale) => sum + sale.valor, 0);
            const totalComissoes = salesData.reduce((sum, sale) => sum + sale.comissaoValor, 0);
            const comissoesPagas = salesData.reduce((sum, sale) => 
                sum + (sale.paidInstallments || 0) * (sale.comissaoValor / sale.installments), 0);
            const comissoesPendentes = totalComissoes - comissoesPagas;
            const vendedoresAtivos = new Set(salesData.map(sale => sale.vendedor)).size;
            const ticketMedio = totalVendas > 0 ? faturamentoTotal / totalVendas : 0;
            
            document.getElementById('admin-total-vendas').textContent = totalVendas;
            document.getElementById('admin-faturamento-total').textContent = formatCurrency(faturamentoTotal);
            document.getElementById('admin-total-comissoes').textContent = formatCurrency(comissoesPagas);
            document.getElementById('admin-comissoes-pendentes').textContent = formatCurrency(comissoesPendentes);
            document.getElementById('admin-vendedores-ativos').textContent = vendedoresAtivos;
            document.getElementById('admin-ticket-medio').textContent = formatCurrency(ticketMedio);
        }

        // Carregar todas as vendas (admin)
        function loadAllSales() {
            const tbody = document.getElementById('todas-vendas');
            
            if (salesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Nenhuma venda encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = salesData.map((sale) => {
                const vendedorName = users.find(u => u.username === sale.vendedor)?.name || sale.vendedor;
                const paidInstallments = sale.paidInstallments || 0;
                const totalInstallments = sale.installments || 1;
                const status = getPaymentStatus(paidInstallments, totalInstallments);
                
                return `
                    <tr>
                        <td>${formatDate(sale.data)}</td>
                        <td>${vendedorName}</td>
                        <td>${sale.cliente}</td>
                        <td>${formatCurrency(sale.valor)}</td>
                        <td>${formatCurrency(sale.comissaoValor)} (${sale.comissaoPerc}%)</td>
                        <td><span class="status-badge status-${status.class}">${status.text}</span></td>
                        <td>
                            <div>${paidInstallments}/${totalInstallments}</div>
                            <button class="btn btn-small btn-info" onclick="updateInstallments('${sale.id}', ${paidInstallments}, ${totalInstallments})">Atualizar</button>
                        </td>
                        <td>
                            <button class="btn btn-danger btn-small" onclick="deleteSale('${sale.id}')">Excluir</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Carregar ranking admin
        function loadAdminRanking() {
            const ranking = calculateRanking();
            const container = document.getElementById('admin-ranking-list');
            
            container.innerHTML = ranking.map((item, index) => {
                const vendedorName = users.find(u => u.username === item.vendedor)?.name || item.vendedor;
                const medal = getMedal(index);
                const rankClass = getRankClass(index);
                const maxComissao = ranking.length > 0 ? ranking[0].totalComissao : 1;
                const progressPercent = (item.totalComissao / maxComissao) * 100;
                
                return `
                    <div class="ranking-item ${rankClass}">
                        <div style="display: flex; align-items: center;">
                            <span class="medal">${medal}</span>
                            <div>
                                <span class="position">${index + 1}¬∫</span>
                                <strong>${vendedorName}</strong>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div><strong>${formatCurrency(item.totalComissao)}</strong></div>
                            <div style="font-size: 0.9rem; color: #666;">${item.totalVendas} vendas</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Calcular ranking
        function calculateRanking() {
            const vendedorStats = {};
            
            salesData.forEach(sale => {
                if (!vendedorStats[sale.vendedor]) {
                    vendedorStats[sale.vendedor] = {
                        vendedor: sale.vendedor,
                        totalVendas: 0,
                        totalComissao: 0
                    };
                }
                
                vendedorStats[sale.vendedor].totalVendas++;
                vendedorStats[sale.vendedor].totalComissao += sale.comissaoValor;
            });
            
            return Object.values(vendedorStats)
                .sort((a, b) => b.totalComissao - a.totalComissao);
        }

        // Criar gr√°fico do vendedor
        function createVendedorChart() {
            const ctx = document.getElementById('vendedor-chart')?.getContext('2d');
            if (!ctx) return;
            
            const vendedorSales = salesData.filter(sale => sale.vendedor === currentUser.username);
            
            // Agrupar vendas por m√™s
            const monthlyData = {};
            const teamMonthlyData = {};
            
            // Dados do vendedor atual
            vendedorSales.forEach(sale => {
                const month = new Date(sale.data).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                monthlyData[month] = (monthlyData[month] || 0) + sale.comissaoValor;
            });
            
            // Dados da equipe (m√©dia)
            salesData.forEach(sale => {
                const month = new Date(sale.data).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                if (!teamMonthlyData[month]) teamMonthlyData[month] = [];
                teamMonthlyData[month].push(sale.comissaoValor);
            });
            
            // Calcular m√©dia da equipe por m√™s
            Object.keys(teamMonthlyData).forEach(month => {
                const vendedoresNoMes = new Set();
                salesData.filter(sale => {
                    const saleMonth = new Date(sale.data).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                    return saleMonth === month;
                }).forEach(sale => vendedoresNoMes.add(sale.vendedor));
                
                const totalVendedores = vendedoresNoMes.size;
                const totalComissoes = teamMonthlyData[month].reduce((sum, val) => sum + val, 0);
                teamMonthlyData[month] = totalVendedores > 0 ? totalComissoes / totalVendedores : 0;
            });
            
            const months = [...new Set([...Object.keys(monthlyData), ...Object.keys(teamMonthlyData)])].sort();
            
            if (vendedorChart) {
                vendedorChart.destroy();
            }
            
            vendedorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Suas Comiss√µes',
                            data: months.map(month => monthlyData[month] || 0),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'M√©dia da Equipe',
                            data: months.map(month => teamMonthlyData[month] || 0),
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolu√ß√£o das Comiss√µes'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Criar gr√°fico do admin
        function createAdminChart() {
            const ctx = document.getElementById('admin-chart')?.getContext('2d');
            if (!ctx) return;
            
            // Agrupar vendas por m√™s
            const monthlyData = {};
            const monthlyCount = {};
            
            salesData.forEach(sale => {
                const month = new Date(sale.data).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                monthlyData[month] = (monthlyData[month] || 0) + sale.valor;
                monthlyCount[month] = (monthlyCount[month] || 0) + 1;
            });
            
            const months = Object.keys(monthlyData).sort();
            
            if (adminChart) {
                adminChart.destroy();
            }
            
            adminChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Faturamento (R$)',
                            data: months.map(month => monthlyData[month] || 0),
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Quantidade de Vendas',
                            data: months.map(month => monthlyCount[month] || 0),
                            type: 'line',
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Panorama de Vendas Mensais'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // Atualizar parcelas de comiss√£o
        async function updateInstallments(saleId, currentPaid, total) {
            const newPaid = prompt(`Quantas parcelas foram pagas?\nAtual: ${currentPaid}/${total}`, currentPaid);
            
            if (newPaid !== null && !isNaN(newPaid) && newPaid >= 0 && newPaid <= total) {
                try {
                    const { db, doc, updateDoc } = window.firebase;
                    await updateDoc(doc(db, 'sales', saleId), {
                        paidInstallments: parseInt(newPaid)
                    });
                    
                    console.log('‚úÖ Parcelas atualizadas!');
                } catch (error) {
                    console.error('‚ùå Erro ao atualizar parcelas:', error);
                    alert('Erro ao atualizar parcelas. Tente novamente.');
                }
            }
        }

        // Modals e formul√°rios
        function openNewSaleModal() {
            document.getElementById('newSaleModal').style.display = 'block';
        }

        function closeNewSaleModal() {
            document.getElementById('newSaleModal').style.display = 'none';
            clearNewSaleForm();
        }

        function clearNewSaleForm() {
            document.getElementById('vendedor-select').value = '';
            document.getElementById('cliente-input').value = '';
            document.getElementById('valor-input').value = '';
            document.getElementById('comissao-input').value = '';
            document.getElementById('parcelas-input').value = '1';
            document.getElementById('status-input').value = 'pendente';
        }

        function populateVendedorSelect() {
            const select = document.getElementById('vendedor-select');
            const vendedores = users.filter(u => u.type === 'vendedor');
            
            select.innerHTML = '<option value="">Selecione um vendedor</option>' +
                vendedores.map(v => `<option value="${v.username}">${v.name}</option>`).join('');
        }

        // Adicionar nova venda
        async function addSale() {
            const vendedor = document.getElementById('vendedor-select').value;
            const cliente = document.getElementById('cliente-input').value;
            const valor = parseFloat(document.getElementById('valor-input').value);
            const comissaoPerc = parseFloat(document.getElementById('comissao-input').value);
            const parcelas = parseInt(document.getElementById('parcelas-input').value);
            const status = document.getElementById('status-input').value;
            
            if (!vendedor || !cliente || !valor || !comissaoPerc || !parcelas) {
                alert('Preencha todos os campos!');
                return;
            }
            
            try {
                const { db, collection, addDoc } = window.firebase;
                const comissaoValor = (valor * comissaoPerc) / 100;
                const paidInstallments = status === 'pago' ? parcelas : 0;
                
                const newSale = {
                    data: new Date(),
                    vendedor: vendedor,
                    cliente: cliente,
                    valor: valor,
                    comissaoPerc: comissaoPerc,
                    comissaoValor: comissaoValor,
                    installments: parcelas,
                    paidInstallments: paidInstallments,
                    createdAt: new Date()
                };
                
                await addDoc(collection(db, 'sales'), newSale);
                closeNewSaleModal();
                console.log('‚úÖ Venda adicionada!');
            } catch (error) {
                console.error('‚ùå Erro ao adicionar venda:', error);
                alert('Erro ao adicionar venda. Tente novamente.');
            }
        }

        // Excluir venda
        async function deleteSale(saleId) {
            if (confirm('Tem certeza que deseja excluir esta venda?')) {
                try {
                    const { db, doc, deleteDoc } = window.firebase;
                    await deleteDoc(doc(db, 'sales', saleId));
                    console.log('‚úÖ Venda exclu√≠da!');
                } catch (error) {
                    console.error('‚ùå Erro ao excluir venda:', error);
                    alert('Erro ao excluir venda. Tente novamente.');
                }
            }
        }

        // Modal gerenciar usu√°rios
        function openUserManagementModal() {
            document.getElementById('userManagementModal').style.display = 'block';
        }

        function closeUserManagementModal() {
            document.getElementById('userManagementModal').style.display = 'none';
        }

        function loadUsersList() {
            const container = document.getElementById('users-list');
            const vendedores = users.filter(u => u.type === 'vendedor');
            
            container.innerHTML = vendedores.map((user) => `
                <div class="user-item">
                    <div>
                        <strong>${user.name}</strong> (${user.username})
                    </div>
                    <div>
                        <button class="btn btn-info btn-small" onclick="editUser('${user.id}', '${user.name}')">Editar</button>
                        <button class="btn btn-danger btn-small" onclick="deleteUser('${user.id}')">Excluir</button>
                    </div>
                </div>
            `).join('');
        }

        async function addUser() {
            const name = document.getElementById('new-user-name').value;
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            
            if (!name || !username || !password) {
                alert('Preencha todos os campos!');
                return;
            }
            
            if (users.find(u => u.username === username)) {
                alert('Nome de usu√°rio j√° existe!');
                return;
            }
            
            try {
                const { db, collection, addDoc } = window.firebase;
                await addDoc(collection(db, 'users'), {
                    username: username,
                    password: password,
                    type: 'vendedor',
                    name: name
                });
                
                document.getElementById('new-user-name').value = '';
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                
                console.log('‚úÖ Vendedor adicionado!');
            } catch (error) {
                console.error('‚ùå Erro ao adicionar vendedor:', error);
                alert('Erro ao adicionar vendedor. Tente novamente.');
            }
        }

        async function editUser(userId, currentName) {
            const newName = prompt('Novo nome:', currentName);
            if (newName && newName.trim()) {
                try {
                    const { db, doc, updateDoc } = window.firebase;
                    await updateDoc(doc(db, 'users', userId), {
                        name: newName.trim()
                    });
                    
                    console.log('‚úÖ Nome atualizado!');
                } catch (error) {
                    console.error('‚ùå Erro ao editar usu√°rio:', error);
                    alert('Erro ao editar usu√°rio. Tente novamente.');
                }
            }
        }

        async function deleteUser(userId) {
            if (confirm('Tem certeza que deseja excluir este vendedor? Suas vendas ser√£o mantidas.')) {
                try {
                    const { db, doc, deleteDoc } = window.firebase;
                    await deleteDoc(doc(db, 'users', userId));
                    console.log('‚úÖ Vendedor exclu√≠do!');
                } catch (error) {
                    console.error('‚ùå Erro ao excluir vendedor:', error);
                    alert('Erro ao excluir vendedor. Tente novamente.');
                }
            }
        }

        // Modal regras de comiss√£o
        function openCommissionRulesModal() {
            document.getElementById('commissionRulesModal').style.display = 'block';
        }

        function closeCommissionRulesModal() {
            document.getElementById('commissionRulesModal').style.display = 'none';
        }

        function loadCommissionRulesList() {
            const container = document.getElementById('rules-list');
            container.innerHTML = commissionRules.map((rule) => `
                <div class="rule-item">
                    <span><strong>${rule.name}:</strong> ${rule.percentage}% em ${rule.installments}x</span>
                    <button class="btn btn-danger btn-small" onclick="deleteCommissionRule('${rule.id}')">Excluir</button>
                </div>
            `).join('');
        }

        async function addCommissionRule() {
            const name = document.getElementById('rule-name').value;
            const percentage = parseFloat(document.getElementById('rule-percentage').value);
            const installments = parseInt(document.getElementById('rule-installments').value);
            
            if (!name || !percentage || !installments) {
                alert('Preencha todos os campos!');
                return;
            }
            
            try {
                const { db, collection, addDoc } = window.firebase;
                await addDoc(collection(db, 'commissionRules'), {
                    name: name,
                    percentage: percentage,
                    installments: installments
                });
                
                document.getElementById('rule-name').value = '';
                document.getElementById('rule-percentage').value = '';
                document.getElementById('rule-installments').value = '1';
                
                console.log('‚úÖ Regra adicionada!');
            } catch (error) {
                console.error('‚ùå Erro ao adicionar regra:', error);
                alert('Erro ao adicionar regra. Tente novamente.');
            }
        }

        async function deleteCommissionRule(ruleId) {
            if (confirm('Tem certeza que deseja excluir esta regra?')) {
                try {
                    const { db, doc, deleteDoc } = window.firebase;
                    await deleteDoc(doc(db, 'commissionRules', ruleId));
                    console.log('‚úÖ Regra exclu√≠da!');
                } catch (error) {
                    console.error('‚ùå Erro ao excluir regra:', error);
                    alert('Erro ao excluir regra. Tente novamente.');
                }
            }
        }

        // Fun√ß√µes utilit√°rias
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('pt-BR');
        }

        function getPaymentStatus(paid, total) {
            if (paid === 0) {
                return { class: 'pendente', text: 'Pendente' };
            } else if (paid === total) {
                return { class: 'pago', text: 'Pago' };
            } else {
                return { class: 'parcial', text: 'Parcial' };
            }
        }

        function getMedal(position) {
            switch(position) {
                case 0: return 'ü•á';
                case 1: return 'ü•à';
                case 2: return 'ü•â';
                default: return 'üèÖ';
            }
        }

        function getRankClass(position) {
            switch(position) {
                case 0: return 'gold';
                case 1: return 'silver';
                case 2: return 'bronze';
                default: return '';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Event listeners
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // Fechar modais ao clicar fora
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
